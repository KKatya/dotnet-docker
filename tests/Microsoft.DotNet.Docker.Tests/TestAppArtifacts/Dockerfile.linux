ARG sdk_image
ARG runtime_image
ARG runtime_deps_image

FROM $sdk_image as build

EXPOSE 80

WORKDIR app
COPY NuGet.config .
COPY *.csproj .
RUN dotnet restore

COPY . .
RUN dotnet build


FROM build as publish_fx_dependent
RUN dotnet publish -c Release -o out


FROM $runtime_image AS fx_dependent_app
EXPOSE 80
WORKDIR /app
COPY --from=publish_fx_dependent /app/out ./
ENTRYPOINT ["dotnet", "app.dll"]


FROM build as publish_self_contained
ARG rid
RUN dotnet restore -r $rid \
    # Checks if nuget in dotnet restore has populated the credential provider cache
    && ls $HOME/.local/share/NuGet/plugins-cache | grep --quiet CredentialProvider.Microsoft.dll \
    && dotnet $NUGET_PLUGIN_PATHS -h
RUN dotnet publish -r $rid -c Release -o out


FROM $runtime_deps_image AS self_contained_app
EXPOSE 80
WORKDIR /app
COPY --from=publish_self_contained /app/out ./
ENTRYPOINT ["./app"]
